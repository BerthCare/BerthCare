name: Deploy Backend to Dev

on:
  push:
    branches: [main]
    paths:
      - 'berthcare-backend/**'
      - '.github/workflows/backend-deploy-dev.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

defaults:
  run:
    working-directory: berthcare-backend

jobs:
  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-dev
          aws-region: ca-central-1

      - name: Validate assumed AWS account
        run: |
          set -euo pipefail
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          if [ "$ACCOUNT_ID" != "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "ERROR: Assumed account $ACCOUNT_ID does not match expected ${{ secrets.AWS_ACCOUNT_ID }}"
            exit 1
          fi
          echo "Validated AWS account $ACCOUNT_ID"

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_NAME: berthcare-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -t "$ECR_REGISTRY/$IMAGE_NAME:$IMAGE_TAG" \
            -t "$ECR_REGISTRY/$IMAGE_NAME:latest" \
            --push \
            .

  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-and-push
    env:
      ECS_CLUSTER: berthcare-dev-cluster
      ECS_SERVICE: berthcare-dev-backend
      TASK_FAMILY: berthcare-dev-backend
      CONTAINER_NAME: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-dev
          aws-region: ca-central-1

      - name: Validate assumed AWS account
        run: |
          set -euo pipefail
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          if [ "$ACCOUNT_ID" != "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "ERROR: Assumed account $ACCOUNT_ID does not match expected ${{ secrets.AWS_ACCOUNT_ID }}"
            exit 1
          fi
          echo "Validated AWS account $ACCOUNT_ID"

      - name: Download task definition
        id: task-def
        run: |
          aws ecs describe-task-definition \
            --task-definition "$TASK_FAMILY" \
            --query taskDefinition > task-definition.json

          # Remove read-only fields before re-registering
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities)' \
            task-definition.json > task-definition.clean.json
          mv task-definition.clean.json task-definition.json

      - name: Prepare image URI
        id: image
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="${ACCOUNT_ID}.dkr.ecr.ca-central-1.amazonaws.com"
          echo "uri=${REGISTRY}/berthcare-backend:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Render task definition with new image
        id: render
        run: |
          set -euo pipefail
          echo "Injecting image and health check (assumes image includes curl and /health on \$PORT or 3000)"

          container_overrides=$(jq \
            --arg IMAGE "${{ steps.image.outputs.uri }}" \
            --arg NAME "$CONTAINER_NAME" \
            '.containerDefinitions |= map(if .name == $NAME then .image = $IMAGE | .healthCheck = {command: ["CMD-SHELL", "curl -f http://localhost:${PORT:-3000}/health || exit 1"], interval: 30, timeout: 5, retries: 3, startPeriod: 60} else . end)' \
            task-definition.json) || {
              echo "Failed to update task definition with new image and health check"
              exit 1
            }

          echo "$container_overrides" > task-definition.json

          if ! jq --arg NAME "$CONTAINER_NAME" '.containerDefinitions[] | select(.name == $NAME) | .healthCheck.command' task-definition.json | grep -q '"CMD-SHELL"'; then
            echo "ERROR: Health check was not injected into task definition for container $CONTAINER_NAME"
            exit 1
          fi

      - name: Register new task definition revision
        id: register
        run: |
          new_td_arn=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition.json \
            --query taskDefinition.taskDefinitionArn \
            --output text)
          echo "arn=$new_td_arn" >> "$GITHUB_OUTPUT"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --task-definition "${{ steps.register.outputs.arn }}" \
            --force-new-deployment

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Backend deploy to dev ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Backend Deployment (dev)*\nStatus: *${{ job.status }}*\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
